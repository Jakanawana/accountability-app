<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Show Up</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  /* ---------- THEME VARIABLES (defaults) ---------- */
  :root{
    --bg: #f4efe9;
    --text: #222;
    --panel-bg: #ffffff;
    --muted: #666;
    --primary: #6b7b6b;
    --primary-contrast: #ffffff;
    --accent1: #4caf50;
    --accent2: #ff5252;
    --card-shadow: 0 4px 10px rgba(0,0,0,.05);
    --gear-bg: #ffffff;

    /* --- dialogue fonts & upgraded modal styles --- */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Merienda:wght@400;700&display=swap');

body {
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* stronger overlay + center modal */
#lockScreen{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.88);
  backdrop-filter: blur(6px);
  color:var(--primary-contrast);
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:2rem;
  z-index:9999;
}

/* bigger, punchy lockBox */
#lockBox{
  width:min(760px, 96vw);
  max-height:86vh;
  overflow:hidden;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  border-radius:18px;
  padding:16px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.04);
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* speaker header */
#speakerHeader{
  display:flex;
  gap:12px;
  align-items:center;
  padding:6px 8px;
}
.speakerAvatar{
  width:48px;height:48px;border-radius:999px;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary-contrast);
  font-family:"Merienda", "Inter", sans-serif;
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
}
.speakerName{
  font-family:"Merienda", "Inter", sans-serif;
  font-weight:700;
  font-size:1.05rem;
  color:var(--primary-contrast);
  text-transform:capitalize;
}

/* dialogue area */
#dialogueWrap{ display:flex; flex-direction:column; gap:8px; align-items:stretch; }
#dialogueLines{
  background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.00));
  padding:12px;
  border-radius:12px;
  overflow:auto;
  max-height:54vh;
  box-shadow: inset 0 -8px 24px rgba(0,0,0,0.06);
}

/* bubble row */
.dialogue-row{ display:flex; gap:10px; align-items:flex-end; margin:6px 0; }
.dialogue-row.npc{ justify-content:flex-start; }
.dialogue-row.user{ justify-content:flex-end; }

/* bubble styles */
.dialogue-bubble{
  max-width:78%;
  padding:12px 14px;
  border-radius:14px;
  line-height:1.3;
  word-break:break-word;
  box-shadow:0 8px 18px rgba(0,0,0,0.12);
  font-size:1rem;
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
.dialogue-bubble.npc{
  background: linear-gradient(180deg, var(--accent1), var(--accent2));
  color:var(--primary-contrast);
  border: 1px solid rgba(255,255,255,0.06);
  border-bottom-left-radius:4px;
}
.dialogue-bubble.user{
  background: rgba(255,255,255,0.06);
  color:var(--text);
  border: 1px solid rgba(0,0,0,0.06);
  border-bottom-right-radius:4px;
}

/* meta row under bubbles */
#dialogTaskMeta{ font-weight:700; color:var(--muted); margin-top:4px; text-align:center; }

/* transform old buttons into dialog-style action bubbles */
#lockButtons{ display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:8px; margin-top:10px; }
.dialog-btn{
  background:transparent;
  border-radius:12px;
  padding:10px 12px;
  border:1px solid rgba(0,0,0,0.06);
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}
.dialog-btn.primary{ background:var(--primary); color:var(--primary-contrast); border: none; }
.dialog-btn.danger{ background:#ff6b6b; color:white; border: none; }
.dialog-btn:active{ transform:translateY(1px); }

/* make cancel less prominent */
#lockBox .cancelBtn{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06); opacity:0.9; }


    /* parameters (mirrors JS defaults) */
    --bg-h: 30;
    --bg-s: 24%;
    --bg-l: 95%;
    --panel-l: 100%;
    --accent-h: 145;
    --accent-s: 80%;
    --accent-l: 52%;
  }

  /* computed vars (these are overwritten by JS when sliders change) */
  :root{
    --bg: hsl(var(--bg-h) var(--bg-s) var(--bg-l));
    --panel-bg: hsl(var(--bg-h) var(--bg-s) var(--panel-l));
    --accent1: hsl(var(--accent-h) var(--accent-s) var(--accent-l));
    --accent2: hsl(calc((var(--accent-h) + 30) % 360) var(--accent-s) var(--accent-l));
    --primary: hsl(var(--accent-h) calc(max(20%, var(--accent-s) - 20%)) calc(max(20%, var(--accent-l) - 24%)));
  }

  /* ---------- BASE UI ---------- */
  *{box-sizing:border-box}
  body{
    font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    margin:0;
    padding:1rem;
    color:var(--text);
    transition: background .25s, color .25s;
  }

  h1{text-align:center;margin:0 0 12px 0;font-size:1.6rem;}

  .panel{
    background:var(--panel-bg);
    padding:1rem;
    border-radius:14px;
    margin-bottom:1rem;
    box-shadow:var(--card-shadow);
    transition: background .25s, box-shadow .25s;
  }

  input,button,select,textarea{
    width:100%;
    padding:.7rem;
    margin-top:.5rem;
    font-size:1rem;
    color:var(--text);
    background:transparent;
    border:1px solid rgba(0,0,0,0.06);
    border-radius:10px;
  }

  button{
    border:none;
    border-radius:10px;
    background:var(--primary);
    color:var(--primary-contrast);
    padding:.7rem .9rem;
    cursor:pointer;
  }

  button.secondary{ background: transparent; color: var(--text); border:1px solid rgba(0,0,0,0.06) }

  .smallBtn{
    padding:.4rem .6rem;
    font-size:.9rem;
    border-radius:8px;
    background:#eee;
    color:#222;
    border:none;
    cursor:pointer;
  }

  /* Weekday selector */
  .dayGrid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:.3rem;
    margin-top:.5rem;
  }

  .dayBtn{
    background:#ddd;
    color:var(--text);
    padding:.5rem;
    border-radius:8px;
    cursor:pointer;
    font-size:.8rem;
    text-align:center;
    user-select:none;
    border:1px solid rgba(0,0,0,0.04);
  }

  .dayBtn.active{
    background:var(--primary);
    color:var(--primary-contrast);
  }

  #lockScreen{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.75);
    color:var(--primary-contrast);
    display:none;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:2rem;
    z-index:999;
  }

  #lockBox{max-width:420px;}
  #lockBox button{margin-top:.6rem;display:block;width:100%;}
  .taskRow{padding:.6rem;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:space-between;}
  .taskMeta{font-size:.85rem;color:var(--muted);margin-top:.2rem;}
  .typeBadge{font-weight:600;margin-right:.5rem;}
  .small{font-size:.85rem;padding:.4rem;border-radius:8px;background:rgba(0,0,0,0.03);}
  .flex{display:flex;gap:.5rem;align-items:center;}

  /* GEAR (settings) */
  #gearButton{
    position:fixed;
    top:12px;
    right:12px;
    width:46px;
    height:46px;
    background:var(--gear-bg);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    cursor:pointer;
    z-index:1100;
  }

  /* Options panel (prettier + scroll) */
  #optionsPanel, #editPanel{
    display:none;
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.45);
    z-index:1200;
    padding:2rem;
    box-sizing:border-box;
  }

  #optionsInner, #editInner{
    max-width:720px;
    margin:0 auto;
    background:var(--panel-bg);
    color:var(--text);
    padding:18px;
    border-radius:14px;
    box-shadow:0 20px 40px rgba(0,0,0,0.12);
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:18px;
    align-items:start;

    /* NEW: prevent cutoff on small/short viewports by making the inner panel scrollable */
    max-height: calc(100vh - 3rem);
    overflow: auto;
  }

  /* left column stacks */
  .controlsColumn{padding-right:8px}
  .controlCard{
    background: rgba(255,255,255,0.02);
    border-radius:12px;
    padding:12px;
    margin-bottom:12px;
    border:1px solid rgba(0,0,0,0.04);
  }
  .controlHeader{font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .controlHint{font-size:.85rem;color:var(--muted);margin-top:6px}

  /* preview column */
  .previewColumn{
    position:relative;
  }
  .closeX{
    position:absolute;
    top:-8px;
    right:-8px;
    background:var(--panel-bg);
    color:var(--text);
    border-radius:10px;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 6px 14px rgba(0,0,0,0.12);
    cursor:pointer;
  }

  .previewBox{
    border-radius:12px;
    padding:14px;
    background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01));
    border:1px solid rgba(0,0,0,0.04);
  }

  .muted{color:var(--muted);font-size:0.9rem}
  .actions {display:flex; gap:.5rem; align-items:center;}
  .actionBtn {background:#eee; color:#222; border-radius:8px; padding:.4rem .6rem; border:none; cursor:pointer;}
  .danger {background:#ff6b6b; color:white;}
  .primary {background:var(--primary); color:var(--primary-contrast);}

  /* slider style */
  .sliderRow{display:flex;gap:.6rem;align-items:center;margin-top:.6rem;}
  .valBox{min-width:56px;text-align:center;font-weight:600;background:transparent;border:0}
  input[type="range"]{width:100%;}
  .sectionTitle{font-weight:700;margin-top:6px;font-size:0.95rem}
  label.small{font-size:.9rem;color:var(--muted);display:block;margin-bottom:6px}
  .radioRow{display:flex;gap:.6rem;align-items:center;margin-top:8px}
  .swatchMini{width:32px;height:20px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);}

  @media (max-width:880px){
    #optionsInner{ grid-template-columns: 1fr; }
    .previewColumn{ order: -1; }
  }
</style>
</head>

<body>

<h1>Show up.</h1>

<!-- GEAR BUTTON -->
<div id="gearButton" title="Options">⚙️</div>

<!-- Progress -->
<div class="panel">
  <h3 style="margin:0 0 8px 0">Today</h3>
  <div style="width:100%;height:18px;background:#ddd;border-radius:10px;overflow:hidden;">
    <div id="dayBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:.3s;"></div>
  </div>
</div>

<!-- Task Input -->
<div class="panel">
  <input id="taskTitle" placeholder="Task (e.g. 'Shower', 'Practice guitar')">
  <input id="taskTime" type="time">
  <input id="taskDuration" type="number" placeholder="Duration (minutes)">

  <select id="taskType">
    <option value="shower">Shower</option>
    <option value="facecare">Face routine</option>
    <option value="teeth">Brush teeth</option>
    <option value="exercise">Exercise</option>
    <option value="stretch">Stretch</option>
    <option value="sleep">Sleep routine</option>
    <option value="wake">Get out of bed</option>
    <option value="morning">Morning routine</option>
    <option value="room">Clean room</option>
    <option value="laundry">Laundry</option>
    <option value="dishes">Dishes</option>
    <option value="music">Music work</option>
    <option value="art">Art practice</option>
    <option value="project">Project work</option>
    <option value="youtube">Limit YouTube</option>
    <option value="social">Limit scrolling</option>
    <option value="errands">Errands</option>
    <option value="general">General</option>
  </select>

  <div style="margin-top:.6rem;">
    <div style="font-size:.9rem;margin-bottom:.4rem;">Repeat on:</div>
    <div class="dayGrid" id="dayGrid">
      <div class="dayBtn" data-day="0">Sun</div>
      <div class="dayBtn" data-day="1">Mon</div>
      <div class="dayBtn" data-day="2">Tue</div>
      <div class="dayBtn" data-day="3">Wed</div>
      <div class="dayBtn" data-day="4">Thu</div>
      <div class="dayBtn" data-day="5">Fri</div>
      <div class="dayBtn" data-day="6">Sat</div>
    </div>
    <div style="font-size:.85rem;color:var(--muted);margin-top:.4rem;">(Leave all days unselected for a one-off task)</div>
  </div>

  <button onclick="addTask()">Commit</button>
</div>

<!-- Today's Tasks Panel -->
<div class="panel">
  <div class="subhead">Today's tasks</div>
  <div id="taskList">
    <p class="muted">No commitments for today yet.</p>
  </div>
</div>

<!-- Commitments (templates) Panel -->
<div class="panel">
  <div class="subhead">Commitments (recurring templates)</div>
  <div id="commitList">
    <p class="muted">No recurring commitments yet.</p>
  </div>
</div>

<!-- Lock Screen (conversation UI) -->
<div id="lockScreen" aria-hidden="true">
  <div id="lockBox" role="dialog" aria-modal="true" aria-label="Task dialog">
    <!-- conversation area -->
    <div id="dialogueWrap" style="text-align:left;">
      <div id="dialogueLines" style="max-height:260px; overflow:auto; padding:6px; border-radius:10px; background:rgba(255,255,255,0.03); margin-bottom:12px;">
        <!-- message bubbles injected here -->
      </div>

      <div id="dialogTaskMeta" class="taskMeta" style="margin-bottom:8px; text-align:center; font-weight:700;"></div>
    </div>

    <!-- response buttons (also clickable bubbles via JS) -->
    <div id="lockButtons" style="margin-top:1rem;">
      <button class="dialog-btn primary" onclick="respondCompleted()">I did it</button>
      <button class="dialog-btn" onclick="respondPartial()">I started</button>
      <button class="dialog-btn" onclick="respondAvoided()">I avoided it</button>
      <button class="dialog-btn" onclick="respondOverwhelmed()">I was overwhelmed</button>
      <button class="dialog-btn" onclick="respondReschedule()">Reschedule</button>
    </div>
    <button id="lockContinueBtn" class="dialog-btn primary" style="display:none;margin-top:0.75rem;">
      Got it
    </button>
  </div>
</div>

    <!-- response buttons (also clickable bubbles via JS) -->
    <div id="lockButtons" style="margin-top:1rem;">
      <button class="dialog-btn primary" onclick="respondCompleted()">I did it</button>
      <button class="dialog-btn" onclick="respondPartial()">I started</button>
      <button class="dialog-btn" onclick="respondAvoided()">I avoided it</button>
      <button class="dialog-btn" onclick="respondOverwhelmed()">I was overwhelmed</button>
      <button class="dialog-btn" onclick="respondReschedule()">Reschedule</button>
    </div>
    <button id="lockContinueBtn" class="dialog-btn primary" style="display:none;margin-top:0.75rem;">
      Got it
    </button>
  </div>
</div>



<!-- EDIT PANEL (for templates) -->
<div id="editPanel">
  <div id="editInner">
    <h2>Edit commitment</h2>

    <input id="editTitle" placeholder="Task title">
    <input id="editTime" type="time">
    <input id="editDuration" type="number" placeholder="Duration (minutes)">

    <select id="editType">
      <option value="shower">Shower</option>
      <option value="facecare">Face routine</option>
      <option value="teeth">Brush teeth</option>
      <option value="exercise">Exercise</option>
      <option value="stretch">Stretch</option>
      <option value="sleep">Sleep routine</option>
      <option value="wake">Get out of bed</option>
      <option value="morning">Morning routine</option>
      <option value="room">Clean room</option>
      <option value="laundry">Laundry</option>
      <option value="dishes">Dishes</option>
      <option value="music">Music work</option>
      <option value="art">Art practice</option>
      <option value="project">Project work</option>
      <option value="youtube">Limit YouTube</option>
      <option value="social">Limit scrolling</option>
      <option value="errands">Errands</option>
      <option value="general">General</option>
    </select>

    <div style="margin-top:.6rem;">
      <div style="font-size:.9rem;margin-bottom:.4rem;">Repeat on:</div>
      <div class="dayGrid" id="editDayGrid">
        <div class="dayBtn" data-day="0">Sun</div>
        <div class="dayBtn" data-day="1">Mon</div>
        <div class="dayBtn" data-day="2">Tue</div>
        <div class="dayBtn" data-day="3">Wed</div>
        <div class="dayBtn" data-day="4">Thu</div>
        <div class="dayBtn" data-day="5">Fri</div>
        <div class="dayBtn" data-day="6">Sat</div>
      </div>
    </div>

    <div style="display:flex;gap:.6rem;margin-top:1rem;">
      <button class="primary" onclick="saveEdit()">Save changes</button>
      <button class="danger" onclick="deleteTemplateFromModal()">Delete</button>
      <button onclick="closeEdit()">Cancel</button>
    </div>
  </div>
</div>

<!-- OPTIONS PANEL (hidden by default) -->
<div id="optionsPanel">
  <div id="optionsInner">
    <!-- LEFT: controls -->
    <div class="controlsColumn">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <div style="font-weight:800;font-size:1.05rem">Options</div>
        <div style="font-size:.9rem;color:var(--muted)">Customize appearance</div>
      </div>

      <!-- DEV MODE CARD (added) -->
      <div class="controlCard">
        <div class="controlHeader">Developer / Test Mode <span style="font-size:.85rem;color:var(--muted)">· sandbox</span></div>

        <label style="display:block;margin-bottom:8px;">
          <input type="checkbox" id="testToggle"> Enable Test Mode (shows dev controls)
        </label>

        <div id="testControls" style="display:none;">
          <div style="margin-bottom:8px;color:var(--muted)">Sandbox dev controls — won't modify real templates.</div>
          <div id="testControlsInner" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>

      <div class="controlCard">
        <div class="controlHeader">Appearance <span style="font-size:.85rem;color:var(--muted)">· colors & contrast</span></div>
        <div class="controlGroup">
          <label class="small">Text color</label>
          <div class="radioRow" style="align-items:center">
            <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
              <input type="radio" name="textColor" id="textBlack" value="black">
              <div class="swatchMini" style="background:#111;border:1px solid rgba(0,0,0,.15)"></div>
              <div>Black</div>
            </label>

            <label style="display:flex;gap:8px;align-items:center;cursor:pointer">
              <input type="radio" name="textColor" id="textWhite" value="white">
              <div class="swatchMini" style="background:#fff;border:1px solid rgba(0,0,0,.06)"></div>
              <div>White</div>
            </label>
          </div>
          <div class="controlHint">Pick the main text color (useful for high-contrast needs).</div>
        </div>
      </div>

      <div class="controlCard">
        <div class="controlHeader">Background</div>

        <label class="small">Hue</label>
        <div class="sliderRow">
          <input type="range" id="bgHue" min="0" max="360" value="30">
          <div class="valBox" id="bgHueVal">30</div>
        </div>

        <label class="small">Saturation</label>
        <div class="sliderRow">
          <input type="range" id="bgSat" min="0" max="100" value="24">
          <div class="valBox" id="bgSatVal">24%</div>
        </div>

        <label class="small">Lightness</label>
        <div class="sliderRow">
          <input type="range" id="bgLight" min="0" max="100" value="95">
          <div class="valBox" id="bgLightVal">95%</div>
        </div>
      </div>

      <div class="controlCard">
        <div class="controlHeader">Panel</div>
        <label class="small">Panel lightness</label>
        <div class="sliderRow">
          <input type="range" id="panelLight" min="0" max="100" value="100">
          <div class="valBox" id="panelLightVal">100%</div>
        </div>
      </div>

      <div class="controlCard">
        <div class="controlHeader">Accent</div>
        <label class="small">Hue</label>
        <div class="sliderRow">
          <input type="range" id="accentHue" min="0" max="360" value="145">
          <div class="valBox" id="accentHueVal">145</div>
        </div>

        <label class="small">Saturation</label>
        <div class="sliderRow">
          <input type="range" id="accentSat" min="0" max="100" value="80">
          <div class="valBox" id="accentSatVal">80%</div>
        </div>

        <label class="small">Lightness</label>
        <div class="sliderRow">
          <input type="range" id="accentLight" min="0" max="100" value="52">
          <div class="valBox" id="accentLightVal">52%</div>
        </div>

        <div style="margin-top:10px; display:flex; gap:.6rem; align-items:center;">
          <button class="smallBtn" id="resetCustom">Reset to defaults</button>
          <div style="font-size:.85rem;color:var(--muted);">Changes save automatically.</div>
        </div>
      </div>

      <div style="display:flex;gap:.6rem;margin-top:10px;align-items:center">
        <button onclick="toggleOptions()">Close</button>
        <button class="secondary" onclick="exportSettings()">Export</button>
        <button class="secondary" onclick="importSettingsPrompt()">Import</button>
      </div>
    </div>

    <!-- RIGHT: preview / quick info -->
    <div class="previewColumn">
      <div class="closeX" title="Close" onclick="toggleOptions()">✕</div>
      <div class="previewBox">
        <div style="font-weight:800;margin-bottom:8px">Preview</div>
        <div style="font-size:.95rem;margin-bottom:8px">Live preview of your color choices:</div>
        <div style="background:var(--panel-bg);padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04)">
          <div style="font-weight:700">• Task title</div>
          <div class="taskMeta" style="margin-bottom:8px">10:00 — ends 10:15</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="small">exercise</div>
            <div style="margin-left:auto;color:var(--muted)">Status: pending</div>
          </div>
        </div>

        <div style="margin-top:12px;" class="muted">
          Tip: use the accent sliders to pick your main app color. If text gets hard to read, toggle Text color to white or black.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- BOOTSTRAP & NORMALIZE ---------- */

// Storage helpers (avoid crashing if localStorage is unavailable)
const memoryStorage = {};
function safeGet(key){
  try { return localStorage.getItem(key); } catch(e){ return Object.prototype.hasOwnProperty.call(memoryStorage, key) ? memoryStorage[key] : null; }
}
function safeSet(key, value){
  try { localStorage.setItem(key, value); } catch(e){ memoryStorage[key] = String(value); }
}

// Load tasks and normalize older entries
let tasks = JSON.parse(safeGet("tasks") || "[]");

// Normalization: keep items which have duration; convert legacy shapes gently
tasks = (tasks || []).map(t => {
  if (!t) return null;
  if (typeof t.duration === "undefined" || t.duration === null) {
    return null;
  }
  if (!Array.isArray(t.days)) t.days = t.days ? (Array.isArray(t.days) ? t.days : []) : [];
  if (typeof t.template === "undefined") t.template = !!(t.days && t.days.length > 0 && t.template !== false);
  if (typeof t.type === "undefined") t.type = t.type || "general";
  if (typeof t.day === "undefined") t.day = new Date(t.start || Date.now()).toDateString();
  return t;
}).filter(Boolean);

safeSet("tasks", JSON.stringify(tasks));

/* ---------- CHARACTER DIALOGUE ENGINE ---------- */

  /* ---------- Dialogue bubble renderer ---------- */

function appendNpcBubble(text, speakerName){
  const container = document.getElementById('dialogueLines');
  if(!container) return;

  const row = document.createElement('div');
  row.className = 'dialogue-row npc';

  const bubble = document.createElement('div');
  bubble.className = 'dialogue-bubble npc';
  bubble.innerText = text || '';

  // optional speaker label above bubble for first message in modal
  row.appendChild(bubble);
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}

function appendUserBubble(text){
  const container = document.getElementById('dialogueLines');
  if(!container) return;

  const row = document.createElement('div');
  row.className = 'dialogue-row user';

  const bubble = document.createElement('div');
  bubble.className = 'dialogue-bubble user';
  bubble.innerText = text || '';

  row.appendChild(bubble);
  container.appendChild(row);
  container.scrollTop = container.scrollHeight;
}


const dialogue = {
  general: {
    completed: ["You did it. I’m impressed.","Task done. Good.","You followed through — proud of you."],
    partial: ["You started. That counts… barely.","Half effort is still effort.","You touched the task. Growth."],
    avoided: ["You avoided it.","You said you would — you didn’t.","Avoidance again. Pattern forming."]
  },
  wake: {
    completed: ["Oh? Up on time.","You beat the bed. Proud.","Good boy. Morning win."],
    partial: ["Eventually conscious.","Late — but alive.","You crawled out. Counts."],
    avoided: ["You lost to your bed.","Alarm rang. You ignored it.","Sleep won again."]
  },
  shower: {
    completed: ["Clean. Civilised. Stunning.","You smell less like depression nest.","Proud of you for basic hygiene."],
    partial: ["Half shower?","Speedrun hygiene I see.","You rinsed. Bare minimum."],
    avoided: ["Skipped showering.","Avoiding hygiene now?","You just didn’t wash."]
  },
  facecare: {
    completed: ["Skin routine done. Glow up era.","Taking care of your face — love that.","Cute and moisturised."],
    partial: ["Half routine.","You tried. I guess.","Better than nothing."],
    avoided: ["Skipped face care.","You forgot again?","Your skin is judging you."]
  },
  exercise: {
    completed: ["Worked out. Hot.","Body maintenance complete.","Proud of you, Jak."],
    partial: ["Half workout.","You started at least.","Baby steps."],
    avoided: ["You dodged exercise.","Avoiding movement again?","Body’s not gonna train itself."]
  },
  music: {
    completed: ["You made music today. Love that.","Creative and disciplined.","Proud of you, Jak."],
    partial: ["You opened the project.","You poked at it.","Creative warmup."],
    avoided: ["You avoided music work.","Scared of your own talent?","Creative avoidance."]
  },
  art: {
    completed: ["You made art. Cute.","Creative brain engaged.","Proud of you."],
    partial: ["You sketched a bit.","You tried.","Warmup counts."],
    avoided: ["You avoided art.","Creative block?","You didn’t even start."]
  },
  cooking: {
    completed: ["You fed yourself. Good.","Sustained life successfully.","I like when you eat properly."],
    partial: ["Snack dinner?","Half effort meal.","Nutrition… adjacent."],
    avoided: ["You didn’t cook.","Surviving on vibes again?","You skipped eating properly."]
  }
};

/* ---------- RANDOM LINE ROUTER ---------- */

function getDialogue(task, result){
  const pack = dialogue[task.type] || dialogue.general;
  const pool = pack[result];
  if(!pool || pool.length === 0) return task.title || "";
  return pool[Math.floor(Math.random() * pool.length)];
}

/* ---------- STATE ---------- */

let activeTask = null;
let editingTemplateId = null;

/* ---------- UI: day selector behavior ---------- */

function wireDayGrid(gridRootSelector){
  const root = document.querySelector(gridRootSelector);
  if(!root) return;
  root.querySelectorAll(".dayBtn").forEach(btn=>{
    btn.onclick = ()=> btn.classList.toggle("active");
  });
}
wireDayGrid("#dayGrid");
wireDayGrid("#editDayGrid");

/* ---------- CUSTOMIZATION (sliders + text color) ---------- */

const STORAGE_PREFIX = "showup_custom_";
const defaults = {
  bgHue: 30, bgSat: 24, bgLight: 95, panelLight: 100,
  accentHue: 145, accentSat: 80, accentLight: 52, textColor: 'black'
};

function savedOrDefault(key){
  const val = safeGet(STORAGE_PREFIX + key);
  return val === null ? defaults[key] : (isNaN(val) ? val : Number(val));
}

function applyTextColor(value){
  if(!value) value = savedOrDefault('textColor');
  if(value === 'white'){
    document.documentElement.style.setProperty('--text', '#ffffff');
    document.documentElement.style.setProperty('--muted', 'rgba(255,255,255,0.75)');
  } else {
    document.documentElement.style.setProperty('--text', '#222222');
    document.documentElement.style.setProperty('--muted', '#666666');
  }
  safeSet(STORAGE_PREFIX + 'textColor', value);
  const b = document.getElementById('textBlack');
  const w = document.getElementById('textWhite');
  if(b) b.checked = (value !== 'white');
  if(w) w.checked = (value === 'white');
}

function applyCustomStylesFromStorage(){
  const bgHue = savedOrDefault('bgHue');
  const bgSat = savedOrDefault('bgSat');
  const bgLight = savedOrDefault('bgLight');
  const panelLight = savedOrDefault('panelLight');
  const accentHue = savedOrDefault('accentHue');
  const accentSat = savedOrDefault('accentSat');
  const accentLight = savedOrDefault('accentLight');

  document.documentElement.style.setProperty('--bg-h', String(bgHue));
  document.documentElement.style.setProperty('--bg-s', String(bgSat) + '%');
  document.documentElement.style.setProperty('--bg-l', String(bgLight) + '%');
  document.documentElement.style.setProperty('--panel-l', String(panelLight) + '%');

  document.documentElement.style.setProperty('--accent-h', String(accentHue));
  document.documentElement.style.setProperty('--accent-s', String(accentSat) + '%');
  document.documentElement.style.setProperty('--accent-l', String(accentLight) + '%');

  const map = [
    ['bgHue','bgHueVal', bgHue, v => v],
    ['bgSat','bgSatVal', bgSat, v => v + '%'],
    ['bgLight','bgLightVal', bgLight, v => v + '%'],
    ['panelLight','panelLightVal', panelLight, v => v + '%'],
    ['accentHue','accentHueVal', accentHue, v => v],
    ['accentSat','accentSatVal', accentSat, v => v + '%'],
    ['accentLight','accentLightVal', accentLight, v => v + '%']
  ];
  map.forEach(([sliderId, labelId, val, fmt])=>{
    const s = document.getElementById(sliderId);
    const l = document.getElementById(labelId);
    if(s) s.value = String(val);
    if(l) l.innerText = fmt(val);
  });

  const a1 = `hsl(${accentHue} ${accentSat}% ${accentLight}%)`;
  const a2 = `hsl(${(accentHue + 30)%360} ${accentSat}% ${accentLight}%)`;
  document.documentElement.style.setProperty('--accent1', a1);
  document.documentElement.style.setProperty('--accent2', a2);
  document.documentElement.style.setProperty('--primary', `hsl(${accentHue} ${Math.max(20, accentSat-20)}% ${Math.max(20, accentLight-24)}%)`);
  const dayBar = document.getElementById('dayBar');
  if(dayBar) dayBar.style.background = `linear-gradient(90deg, ${a1}, ${a2})`;
}

function saveCustom(key, value){
  safeSet(STORAGE_PREFIX + key, String(value));
  applyCustomStylesFromStorage();
}

['bgHue','bgSat','bgLight','panelLight','accentHue','accentSat','accentLight'].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', (e)=>{
    const v = Number(e.target.value);
    const label = document.getElementById(id + 'Val');
    if(label){
      label.innerText = id.toLowerCase().includes('hue') ? String(v) : (String(v) + (id.toLowerCase().includes('hue') ? '' : '%'));
    }
    saveCustom(id, v);
  });
});

const rb = document.getElementById('textBlack');
const rw = document.getElementById('textWhite');
if(rb) rb.addEventListener('change', (e)=>{ if(e.target.checked) applyTextColor('black'); });
if(rw) rw.addEventListener('change', (e)=>{ if(e.target.checked) applyTextColor('white'); });

applyCustomStylesFromStorage();
applyTextColor(safeGet(STORAGE_PREFIX + 'textColor') || defaults.textColor);

/* ---------- SAVE / RENDER / HELPERS (task UI) ---------- */

function save() {
  safeSet("tasks", JSON.stringify(tasks));
  render();
  updateDayBar();
}

function render() {
  renderToday();
  renderCommitments();
}

function renderToday(){
  const list = document.getElementById("taskList");
  list.innerHTML = "";

  const today = new Date().toDateString();
  const active = tasks.filter(t => !t.template && !t.done && new Date(t.day).toDateString() === today);

  if (active.length === 0) {
    list.innerHTML = "<p class='muted'>No commitments for today yet.</p>";
    return;
  }

  active.forEach(t => {
    const div = document.createElement("div");
    div.className = "taskRow";
    const startDate = new Date(t.start);
    const endDate = new Date(t.start + t.duration * 60000);

    const left = document.createElement("div");
    left.innerHTML = `<div style="font-weight:600">${t.title}</div><div class="taskMeta">${startDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} — ends ${endDate.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>`;

    const right = document.createElement("div");
    right.innerHTML = `<div class="small">${t.type}</div>`;

    div.appendChild(left);
    div.appendChild(right);
    list.appendChild(div);
  });
}

function renderCommitments(){
  const list = document.getElementById("commitList");
  list.innerHTML = "";

  const templates = tasks.filter(t => t.template);

  if (templates.length === 0) {
    list.innerHTML = "<p class='muted'>No recurring commitments yet.</p>";
    return;
  }

  templates.forEach(t => {
    const row = document.createElement("div");
    row.className = "taskRow";

    const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const daysStr = (Array.isArray(t.days) && t.days.length) ? t.days.map(d => dayNames[d]).join(", ") : "—";
    const hh = (typeof t.startHour !== "undefined") ? String(t.startHour).padStart(2,'0') : new Date(t.start).getHours();
    const mm = (typeof t.startMinute !== "undefined") ? String(t.startMinute).padStart(2,'0') : new Date(t.start).getMinutes();
    const timeStr = `${hh}:${String(mm).padStart(2,'0')}`;

    const left = document.createElement("div");
    left.style.flex = "1";
    left.innerHTML = `<div style="font-weight:600">${t.title}</div><div class="taskMeta">On: ${daysStr} · ${timeStr} · ${t.duration} min</div>`;

    const right = document.createElement("div");
    right.className = "actions";
    right.innerHTML = `
      <button class="actionBtn" onclick="openEditModal(${t.id})">Edit</button>
      <button class="actionBtn danger" onclick="deleteTemplate(${t.id})">Delete</button>
    `;

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });
}

/* ---------- ADD TASK (handles template vs one-off) ---------- */

function addTask() {
  const title = document.getElementById("taskTitle").value.trim();
  const time = document.getElementById("taskTime").value;
  const duration = parseInt(document.getElementById("taskDuration").value, 10);
  const type = document.getElementById("taskType").value;

  const selectedDays = [...document.querySelectorAll("#dayGrid .dayBtn.active")].map(b => parseInt(b.dataset.day, 10));

  if (!title || !time || !duration) {
    console.warn("Missing title/time/duration");
    return;
  }

  const [h, m] = time.split(":").map(Number);

  if (selectedDays.length > 0) {
    const template = {
      id: Date.now(),
      title,
      type,
      startHour: h,
      startMinute: m,
      duration,
      days: selectedDays,
      template: true,
      done: false,
      response: null,
      escalation: 0,
      lastPrompt: 0,
      day: new Date().toDateString()
    };
    tasks.push(template);
    spawnRecurringForTemplate(template);
    save();

    document.getElementById("taskTitle").value = "";
    document.getElementById("taskTime").value = "";
    document.getElementById("taskDuration").value = "";
    document.querySelectorAll("#dayGrid .dayBtn").forEach(b => b.classList.remove("active"));
    return;
  }

  const now = new Date();
  const start = new Date();
  start.setHours(h, m, 0, 0);
  if (start.getTime() < Date.now()) start.setDate(start.getDate() + 1);

  const oneOff = {
    id: Date.now(),
    title,
    type,
    start: start.getTime(),
    duration,
    days: [],
    template: false,
    done: false,
    response: null,
    escalation: 0,
    lastPrompt: 0,
    day: start.toDateString()
  };

  tasks.push(oneOff);
  save();

  document.getElementById("taskTitle").value = "";
  document.getElementById("taskTime").value = "";
  document.getElementById("taskDuration").value = "";
}

/* ---------- SPAWN RECURRING ---------- */

function spawnRecurring() {
  const now = new Date();
  const todayIdx = now.getDay();

  const templates = tasks.filter(t => t.template === true);

  templates.forEach(t => {
    if (!Array.isArray(t.days) || t.days.length === 0) return;
    if (!t.days.includes(todayIdx)) return;

    const exists = tasks.some(x =>
      !x.template &&
      x.title === t.title &&
      new Date(x.day).toDateString() === new Date().toDateString()
    );
    if (exists) return;

    const start = new Date();
    let hour = typeof t.startHour !== "undefined" ? t.startHour : new Date(t.start).getHours();
    let minute = typeof t.startMinute !== "undefined" ? t.startMinute : new Date(t.start).getMinutes();
    start.setHours(hour, minute, 0, 0);

    tasks.push({
      id: Date.now() + Math.floor(Math.random()*1000),
      title: t.title,
      type: t.type || "general",
      start: start.getTime(),
      duration: t.duration,
      days: t.days.slice(),
      template: false,
      done: false,
      response: null,
      escalation: 0,
      lastPrompt: 0,
      day: new Date().toDateString()
    });
  });

  save();
}

function spawnRecurringForTemplate(template){
  const now = new Date();
  const todayIdx = now.getDay();
  if (!Array.isArray(template.days) || !template.days.includes(todayIdx)) return;

  const exists = tasks.some(x =>
    !x.template &&
    x.title === template.title &&
    new Date(x.day).toDateString() === new Date().toDateString()
  );
  if (exists) return;

  const start = new Date();
  let hour = typeof template.startHour !== "undefined" ? template.startHour : new Date(template.start || Date.now()).getHours();
  let minute = typeof template.startMinute !== "undefined" ? template.startMinute : new Date(template.start || Date.now()).getMinutes();
  start.setHours(hour, minute, 0, 0);

  tasks.push({
    id: Date.now() + Math.floor(Math.random()*1000),
    title: template.title,
    type: template.type || "general",
    start: start.getTime(),
    duration: template.duration,
    days: template.days.slice(),
    template: false,
    done: false,
    response: null,
    escalation: 0,
    lastPrompt: 0,
    day: new Date().toDateString()
  });

  save();
}

/* ---------- CHECK & LOCK ---------- */

function checkTasks() {
  const now = Date.now();

  for (const t of tasks) {
    if (t.template || t.done) continue;
    if (!t.duration) continue;
    const endTime = t.start + (t.duration * 60000);
    if (now > endTime) {
      activeTask = t;
      const line = getDialogue(t, "avoided");
      document.getElementById('dialogueLines').innerHTML = '';

      appendNpcBubble(line);

      document.getElementById('dialogTaskMeta').innerText =
        `[${t.type}] ${t.title}`;

      document.getElementById('lockScreen').style.display = 'flex';
      break;
    }
  }
}

// sets header speaker (call before showing modal)
function setSpeakerName(name){
  // ensure speaker header exists
  let header = document.getElementById('speakerHeader');
  if(!header){
    // create header at the top of lockBox
    const lockBox = document.getElementById('lockBox');
    header = document.createElement('div');
    header.id = 'speakerHeader';
    header.innerHTML = `
      <div class="speakerAvatar">Y</div>
      <div>
        <div class="speakerName" id="speakerNameEl">${name || 'yaoi guy'}</div>
        <div style="font-size:.85rem;color:rgba(255,255,255,0.7);">tap a response</div>
      </div>
    `;
    lockBox.insertBefore(header, lockBox.firstChild);
  } else {
    const nameEl = document.getElementById('speakerNameEl');
    if(nameEl) nameEl.innerText = name || 'yaoi guy';
  }
}

// close + restore page scrolling
function closeLock(){
  document.getElementById("lockScreen").style.display = "none";
  const continueBtn = document.getElementById("lockContinueBtn");
  if(continueBtn) continueBtn.style.display = "none";
  try { document.body.style.overflow = ''; } catch(e){}
}
function closeLock(){
  document.getElementById("lockScreen").style.display = "none";
  const continueBtn = document.getElementById("lockContinueBtn");
  if(continueBtn) continueBtn.style.display = "none";
  try { document.body.style.overflow = ''; } catch(e){}
}

// ensure opening modal disables page scroll
function openLockModal(){
  try{ document.body.style.overflow = 'hidden'; }catch(e){}
  document.getElementById('lockScreen').style.display = 'flex';
  // prevent clicks on overlay from closing or interacting unintentionally
  const lockBox = document.getElementById('lockBox');
  lockBox.addEventListener('click', e => e.stopPropagation());
}


/* ---------- EDIT/DELETE TEMPLATES ---------- */

function openEditModal(id){
  const template = tasks.find(t=>t.id===id && t.template);
  if(!template) return alert("Template not found.");
  editingTemplateId = id;
  document.getElementById("editTitle").value = template.title || "";
  const hh = typeof template.startHour !== "undefined" ? String(template.startHour).padStart(2,'0') : new Date(template.start || Date.now()).getHours();
  const mm = typeof template.startMinute !== "undefined" ? String(template.startMinute).padStart(2,'0') : new Date(template.start || Date.now()).getMinutes();
  document.getElementById("editTime").value = `${hh}:${String(mm).padStart(2,'0')}`;
  document.getElementById("editDuration").value = template.duration || 10;
  document.getElementById("editType").value = template.type || "general";
  document.querySelectorAll("#editDayGrid .dayBtn").forEach(b=>b.classList.remove("active"));
  (template.days || []).forEach(d=>{
    const btn = document.querySelector(`#editDayGrid .dayBtn[data-day='${d}']`);
    if(btn) btn.classList.add("active");
  });
  document.getElementById("editPanel").style.display = "block";
}
function closeEdit(){ editingTemplateId=null; document.getElementById("editPanel").style.display="none"; }
function saveEdit(){
  if(!editingTemplateId) return;
  const idx = tasks.findIndex(t=>t.id===editingTemplateId && t.template);
  if(idx === -1) return alert("Template not found (save).");
  const title = document.getElementById("editTitle").value.trim();
  const time = document.getElementById("editTime").value;
  const duration = parseInt(document.getElementById("editDuration").value,10);
  const type = document.getElementById("editType").value;
  const days = [...document.querySelectorAll("#editDayGrid .dayBtn.active")].map(b=>parseInt(b.dataset.day,10));
  if(!title || !time || !duration) return alert("Please provide title, time, duration.");
  const [h, m] = time.split(":").map(Number);
  tasks[idx].title = title; tasks[idx].type = type; tasks[idx].startHour = h; tasks[idx].startMinute = m; tasks[idx].duration = duration; tasks[idx].days = days;
  save();
  spawnRecurringForTemplate(tasks[idx]);
  closeEdit();
}
function deleteTemplate(id){
  if(!confirm("Delete this recurring commitment? This will stop it from spawning future instances.")) return;
  tasks = tasks.filter(t => !(t.id===id && t.template));
  save();
}
function deleteTemplateFromModal(){ if(!editingTemplateId) return; deleteTemplate(editingTemplateId); closeEdit(); }

/* ---------- DAY BAR ---------- */
function updateDayBar() {
  const today = new Date().toDateString();
  const todayTasks = tasks.filter(t => t.day === today && !t.template);
  if (todayTasks.length === 0) { document.getElementById("dayBar").style.width = "0%"; return; }
  let score = 0;
  todayTasks.forEach(t => {
    if (t.response === "completed") score += 1;
    else if (t.response === "avoided") score -= 1;
  });
  const percent = ((score + todayTasks.length) / (2 * todayTasks.length)) * 100;
  document.getElementById("dayBar").style.width = Math.max(0, percent) + "%";
}

/* ---------- DEV MODE (ALARM SIMULATOR) ---------- */

/* single optionsOpen var and toggle */
let optionsOpen = false;
function toggleOptions(){ optionsOpen = !optionsOpen; document.getElementById("optionsPanel").style.display = optionsOpen ? "block" : "none"; }
document.getElementById("gearButton").addEventListener("click", toggleOptions);

/* dev escalation state */
let devEscalation = 0;

/* show/hide testControls area when checkbox changes */
document.addEventListener('change', (e)=>{
  if (e.target && e.target.id === 'testToggle') {
    document.getElementById('testControls').style.display = e.target.checked ? 'block' : 'none';
  }
});

/* inject dev UI (task type selector + simulate buttons) into the testControlsInner container */
(function injectDevUI(){
  const container = document.getElementById('testControlsInner');
  if(!container) return;

  container.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px;">
      <label style="font-size:.9rem">Select task type to simulate:</label>
      <select id="devType" style="padding:.5rem;border-radius:8px;">
        <option value="wake">Wake up</option>
        <option value="shower">Shower</option>
        <option value="facecare">Facecare</option>
        <option value="exercise">Exercise</option>
        <option value="music">Music</option>
        <option value="art">Art</option>
        <option value="cooking">Cooking</option>
        <option value="general">General</option>
      </select>

      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="smallBtn" onclick="devSimulate('avoided')">Simulate Missed Alarm</button>
        <button class="smallBtn" onclick="devSimulate('partial')">Simulate Partial</button>
        <button class="smallBtn" onclick="devSimulate('completed')">Simulate Completed</button>
      </div>

      <div style="display:flex;gap:8px;">
        <button class="smallBtn" onclick="devEscalate()">Escalate Tone</button>
        <button class="smallBtn" onclick="devReset()">Reset Escalation</button>
      </div>
    </div>
  `;
})();

/* create and show lock dialog using real routing and make activeTask available to response handlers */
function devSimulate(result){
  const sel = document.getElementById('devType');
  const type = sel ? sel.value : 'general';

  const fakeTask = {
    id: 'dev-' + Date.now(),
    title: 'DEV TEST TASK',
    type: type,
    escalation: devEscalation,
    duration: 10
  };

  activeTask = fakeTask;

  // clear old dialogue
  document.getElementById('dialogueLines').innerHTML = '';

  const line = getDialogue(fakeTask, result);

  appendNpcBubble(line);

  document.getElementById('dialogTaskMeta').innerText =
    `[${type}] Dev Simulation`;

  document.getElementById('lockScreen').style.display = 'flex';
}

/* escalate / reset */
function devEscalate(){
  devEscalation++;
  alert('Dev escalation level: ' + devEscalation);
}
function devReset(){
  devEscalation = 0;
  alert('Dev escalation reset');
}

/* ---------- START: spawn + intervals ---------- */
  /* =========================================================
   RESPONSE LOCK SYSTEM (prevents multi-click cheating)
   ========================================================= */

let responseLocked = false;

function lockResponses(){
  responseLocked = true;
  document.querySelectorAll('#lockButtons button').forEach(btn=>{
    btn.disabled = true;
    btn.style.opacity = 0.5;
    btn.style.cursor = 'not-allowed';
  });
}

function unlockResponses(){
  responseLocked = false;
  document.querySelectorAll('#lockButtons button').forEach(btn=>{
    btn.disabled = false;
    btn.style.opacity = 1;
    btn.style.cursor = 'pointer';
  });
}

const continueBtn = document.getElementById("lockContinueBtn");
if(continueBtn){
  continueBtn.addEventListener("click", ()=>{
    closeLock();
    unlockResponses();
  });
}

const continueBtn = document.getElementById("lockContinueBtn");
if(continueBtn){
  continueBtn.addEventListener("click", ()=>{
    closeLock();
    unlockResponses();
  });
}

const continueBtn = document.getElementById("lockContinueBtn");
if(continueBtn){
  continueBtn.addEventListener("click", ()=>{
    closeLock();
    unlockResponses();
  });
}

const continueBtn = document.getElementById("lockContinueBtn");
if(continueBtn){
  continueBtn.addEventListener("click", ()=>{
    closeLock();
    unlockResponses();
  });
}

/* Override your existing handler safely */

function handleUserResponse(resultKey){
  if(!activeTask) return;

  // stop spam clicking
  if(responseLocked) return;

  lockResponses();

  const labelMap = {
    completed: "I did it",
    partial: "I started",
    avoided: "I avoided it",
    overwhelmed: "I was overwhelmed",
    rescheduled: "Reschedule"
  };

  appendUserBubble(labelMap[resultKey] || resultKey);

  setTimeout(()=>{
    const reply = getDialogue(activeTask, resultKey);
    appendNpcBubble(reply);
    if(continueBtn){
      continueBtn.style.display = "block";
    }
  }, 300);

  // store result
  activeTask.response = resultKey;

  if(resultKey === 'completed'){
    activeTask.done = true;
  }

  save();
  updateDayBar();

  // wait for user confirmation before closing
}

/* Button wrappers */

function respondCompleted(){ handleUserResponse('completed'); }
function respondPartial(){ handleUserResponse('partial'); }
function respondAvoided(){ handleUserResponse('avoided'); }
function respondOverwhelmed(){ handleUserResponse('overwhelmed'); }
function respondReschedule(){ handleUserResponse('rescheduled'); }

spawnRecurring();
setInterval(spawnRecurring, 60 * 60 * 1000); // hourly spawn
setInterval(checkTasks, 60 * 1000); // check every minute

render();
updateDayBar();

</script>

</body>
</html>




